# AI 导入并发与防截断逻辑说明

本文档详细说明了在 AI 导入过程中，如何通过并发处理提高速度，同时防止因文本截断导致的题目遗漏、错误或重复问题。

## 1. 核心挑战

当处理大型文档（如几百页的题库）时，一次性将所有内容发送给 AI 会导致以下问题：

1. **Token 限制**：超过 AI 模型的上下文窗口限制。
2. **超时**：处理时间过长，导致 HTTP 请求超时。
3. **内存溢出**：手机端内存不足。

因此，必须将文档**切片（Chunking）**处理。但简单的切片会导致：

- **截断问题**：一个题目被切成两半，前半部分在 Chunk A，后半部分在 Chunk B。
- **上下文丢失**：AI 无法理解只有一半的题目。

## 2. 解决方案：滑动窗口 + 智能丢弃

我们采用了 **“带重叠的滑动窗口（Sliding Window with Overlap）”** 策略，配合 **“首尾丢弃（Discard Partials）”** 规则。

### 2.1 逻辑图解

假设文档内容如下（Q代表题目）：
`[Q1] [Q2] [Q3] [Q4] [Q5]`

**分块策略（假设每块能装 2.5 个题目）：**

- **Chunk 1**: `[Q1] [Q2] [Q3前半部分]`
- **Chunk 2**: `[Q2后半部分] [Q3] [Q4] [Q5前半部分]` (注意：这里有重叠)

**实际处理逻辑：**

我们设置了约 **10% 的重叠区（Overlap）**。

- **Chunk 1 处理规则**：
  - **头部**：这是第一块，保留所有开始的内容。
  - **中间**：正常识别 Q1, Q2。
  - **尾部**：识别到 Q3 只有前半部分（不完整），**丢弃 Q3**。
  - **输出**：Q1, Q2

- **Chunk 2 处理规则**：
  - **头部**：识别到 Q2 的后半部分（不完整），**丢弃 Q2**。
  - **中间**：正常识别 Q3, Q4。
  - **尾部**：识别到 Q5 只有前半部分（不完整），**丢弃 Q5**。
  - **输出**：Q3, Q4

**最终合并**：
`[Q1, Q2]` + `[Q3, Q4]` = `[Q1, Q2, Q3, Q4]`

### 2.2 关键技术点

1. **重叠（Overlap）**：
    - 我们计算分块大小时，会预留 `chunkSize * 0.1` 的重叠字符。
    - 这确保了“被切断的题目”一定会在**下一个分块**中完整出现。

2. **Prompt 工程（提示词控制）**：
    - 我们在系统提示词中明确指令 AI：
        > "1. **Discard Incomplete Start**: If the chunk starts with the middle of a question... ignore it."
        > "2. **Discard Incomplete End**: If the chunk ends with an incomplete question... ignore it."
    - 这利用了 LLM 的语义理解能力，比传统的正则匹配更准确。

3. **并发控制（Concurrency）**：
    - **设置**：用户可在设置中调整“并发请求数”（默认 3）。
    - **原理**：同时发送 N 个 HTTP 请求。
    - **限流保护**：对于 `o1` 或 `reasoner` 等推理模型，系统会自动将并发强制降为 1，以防止触发 API 的速率限制（Rate Limit）或过长的排队时间。

## 3. 防重复机制

虽然重叠机制保证了**不遗漏**，但理论上可能导致**重复**（例如重叠区刚好包含一个完整的短题目）。

- **当前机制**：依赖 AI 的“丢弃不完整”指令。如果题目在重叠区完整存在，AI 可能会在两个 Chunk 中都输出它。
- **后续优化**：建议在导入完成后，增加一步“去重”操作（根据题目内容 Hash 去重），以确保 100% 无重复。

## 4. 总结

| 问题 | 解决方案 |
| :--- | :--- |
| **遗漏** | **重叠切片**：确保边界处的题目在下一块完整出现。 |
| **错误（断句）** | **智能丢弃**：Prompt 指令 AI 忽略首尾的不完整片段。 |
| **速度慢** | **并发请求**：支持多线程同时处理分块。 |
| **API 限制** | **自动降级**：推理模型自动单线程，普通模型多线程。 |
